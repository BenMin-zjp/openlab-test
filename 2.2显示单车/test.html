<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>map-embedded</title>
  <!-- 引入 Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #osm-map{width:100%;height:95vh;margin:20px 0}
    .legend{position:fixed;right:12px;bottom:12px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 10px;font:12px/1.2 system-ui}
    .legend i{display:inline-block;width:10px;height:10px;margin-right:6px;border:1px solid #999;vertical-align:middle}
  </style>
</head>
<body>
  <h1>山东大学电动车可视化</h1>
  <!-- 全宽、高度为浏览器窗口95%的空盒子，后面塞地图 -->
  <div id="osm-map"></div>

  <!-- ========== 你的 e-bike.json 内容，内嵌 ========== -->
  <script id="e-bike-json" type="application/json">
  {
    "type": "FeatureCollection",
    "features": [
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6845,36.3592]},"properties":{"bike_id":"MT-SDU-001","battery":87,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6847,36.3593]},"properties":{"bike_id":"MT-SDU-002","battery":42,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6844,36.3594]},"properties":{"bike_id":"MT-SDU-003","battery":95,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6835,36.3658]},"properties":{"bike_id":"MT-SDU-004","battery":63,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6837,36.3659]},"properties":{"bike_id":"MT-SDU-005","battery":29,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6836,36.3660]},"properties":{"bike_id":"MT-SDU-006","battery":78,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6834,36.3657]},"properties":{"bike_id":"MT-SDU-007","battery":15,"status":"待充电"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6822,36.3626]},"properties":{"bike_id":"MT-SDU-008","battery":91,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6824,36.3627]},"properties":{"bike_id":"MT-SDU-009","battery":55,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6823,36.3628]},"properties":{"bike_id":"MT-SDU-010","battery":33,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6821,36.3625]},"properties":{"bike_id":"MT-SDU-011","battery":67,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6825,36.3626]},"properties":{"bike_id":"MT-SDU-012","battery":8,"status":"待充电"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6877,36.3597]},"properties":{"bike_id":"MT-SDU-013","battery":72,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6879,36.3598]},"properties":{"bike_id":"MT-SDU-014","battery":49,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6876,36.3599]},"properties":{"bike_id":"MT-SDU-015","battery":93,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6880,36.3596]},"properties":{"bike_id":"MT-SDU-016","battery":22,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6850,36.3586]},"properties":{"bike_id":"MT-SDU-017","battery":58,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6852,36.3588]},"properties":{"bike_id":"MT-SDU-018","battery":81,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6849,36.3587]},"properties":{"bike_id":"MT-SDU-019","battery":11,"status":"待充电"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6812,36.3588]},"properties":{"bike_id":"MT-SDU-020","battery":66,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6814,36.3589]},"properties":{"bike_id":"MT-SDU-021","battery":37,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6813,36.3590]},"properties":{"bike_id":"MT-SDU-022","battery":98,"status":"可用"}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[120.6811,36.3587]},"properties":{"bike_id":"MT-SDU-023","battery":45,"status":"可用"}}
    ]
  }
  </script>

  <!-- ========== 你的 parkingLot.json 内容，内嵌（示例，可替换成你自己的） ========== -->
  <script id="parking-json" type="application/json">
  {
    "type":"FeatureCollection",
    "features":[
      {
        "type":"Feature",
        "properties":{"name":"中心停车区A","capacity":120},
        "geometry":{"type":"Polygon","coordinates":[
          [[120.6839,36.3648],[120.6852,36.3649],[120.6851,36.3660],[120.6838,36.3659],[120.6839,36.3648]]
        ]}
      },
      {
        "type":"Feature",
        "properties":{"name":"南区停车区B","capacity":80},
        "geometry":{"type":"Polygon","coordinates":[
          [[120.6841,36.3592],[120.6850,36.3593],[120.6850,36.3600],[120.6840,36.3599],[120.6841,36.3592]]
        ]}
      }
    ]
  }
  </script>

  <script>
    // 初始化地图：山东大学（青岛校区）附近，缩放 15（街道级）
    const map = L.map('osm-map').setView([36.365, 120.684], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 电量对应颜色（>70 绿，>30 橙，否则红）
    const batteryColor = b => b > 70 ? 'green' : b > 30 ? 'orange' : 'red';

    // 兜底：若坐标误写成 [lat, lon]，自动交换为 [lon, lat]
    function coordsToLatLngFix(coords){
      let [x,y]=coords; // GeoJSON 规范是 [lon,lat]
      if (Math.abs(y)>90 && Math.abs(x)<=90){ [x,y]=[y,x]; }
      return new L.LatLng(y,x);
    }

    // 从 <script type="application/json"> 读取并解析
    function readJson(id){
      const el=document.getElementById(id);
      if(!el) return null;
      try{ return JSON.parse(el.textContent); }
      catch(e){ console.error(id,'解析失败：',e); return null; }
    }

    const parkingGeo = readJson('parking-json');
    const bikeGeo    = readJson('e-bike-json');

    // ============== 停车区（你的写法保持不变，只是把数据来源改为内嵌） ==============
    let bounds = L.latLngBounds([]);
    if (parkingGeo){
      const parkingLayer = L.geoJSON(parkingGeo, {
        coordsToLatLng: coordsToLatLngFix,
        style: () => ({color: 'blue', weight: 2, fillOpacity: 0.2}),
        onEachFeature: (f, layer) => {
          const name = f.properties?.name ?? '未命名';
          const cap  = f.properties?.capacity ?? '未知';
          layer.bindPopup(`名称：${name}<br>容量：${cap}辆`);
        }
      }).addTo(map);
      try{ bounds.extend(parkingLayer.getBounds()); }catch{}
    }

    // ============== 单车（适配你的字段：bike_id / battery / status） ==============
    if (bikeGeo){
      const bikeLayer = L.geoJSON(bikeGeo, {
        coordsToLatLng: coordsToLatLngFix,
        pointToLayer: (f,latlng)=>{
          const b = Number(f.properties?.battery);
          return L.circleMarker(latlng, {
            radius: 8,
            color: 'white', weight: 2,
            fillColor: batteryColor(b),
            fillOpacity: 0.9
          });
        },
        onEachFeature: (f,layer)=>{
          const id = f.properties?.bike_id ?? '未知';
          const b  = f.properties?.battery ?? '未知';
          const st = f.properties?.status  ?? '';
          layer.bindPopup(`编号：${id}<br>电量：${b}%${st?`<br>状态：${st}`:''}`);
        }
      }).addTo(map);
      try{ bounds.extend(bikeLayer.getBounds()); }catch{}
    }

    // 视野适配
    if (bounds.isValid()) map.fitBounds(bounds.pad(0.12));

    // 简单图例（不影响功能）
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div><i style="background:green"></i>电量 > 70%</div>
        <div><i style="background:orange"></i>30% ~ 70%</div>
        <div><i style="background:red"></i>< 30%</div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
